<!DOCTYPE html>
<html lang="en">
<head>    
<meta charset="UTF-8">    
<title>Chinese Painting</title>
<link rel='stylesheet' href='/static/bootstrap/css/bootstrap.css'>
<script src="/static/jquery/1.11.3/jquery.min.js"></script>
<script src="/static/bootstrap/js/bootstrap.js"></script>
</head>
<body>
  <canvas id="canvas" style="position:absolute; z-index:2;"></canvas>
  <img id="backgroundImage" src="/static/painting/{{paintingIndex}}.png" style="position:absolute; z-index:1;" height="700"><img>
  <div class="btn-group" role="group" style="position:absolute; z-index:3">
    <button id="newMountainBTN" type="button" class="btn btn-default" onclick="newMountain();">新建-山</button>
    <button id="newPlaneBTN" type="button" class="btn btn-default" onclick="newPlane();">新建-地</button>
    <button id="newHorizontalReferenceStrokeBTN" type="button" class="btn btn-default" onclick="newHorizontalReferenceStroke();">新建-参考线</button>
    <button id="newHorizontalRidgeStrokeBTN" type="button" class="btn btn-default" onclick="newHorizontalRidgeStroke();">新建-水平边缘线</button>
    <button id="newVerticalRidgeStrokeBTN" type="button" class="btn btn-default" onclick="newVerticalRidgeStroke();">新建-垂直边缘线</button>
    <button id="saveBTN" type="button" class="btn btn-default" onclick="save();">保存当前对象</button>
    <button id="submitBTN" type="button" class="btn btn-default">提交</button>
  </div>
</body>
<script>
        var pixelList = new Array();
        var currentStrokeStyle = '#000000';
        var currentObject;
        var canvas;
        var currentType;

        $("#submitBTN").click(function() {
          $("#request-process-patent").html("正在提交数据，请勿关闭当前窗口...");
          $.ajax({
              type: "POST",
              url: "/achieveSketch",
              data: JSON.stringify({'pixel': pixelList, 'size':{'width':canvas.width, 'height':canvas.height}}),
              dataType: "json",
              success: function (message) {
                  if (message > 0) {
                      alert("请求已提交！我们会尽快与您取得联系");
                  }
              },
              error: function (message) {
                  $("#request-process-patent").html("提交数据失败！");
              }
          });
      });

        function newMountain() {
          refreshCanvas();
          currentObject = new Object();
          currentObject['horizontalReference'] = new Array();
          currentObject['horizontalRidge'] = new Array();
          currentObject['verticalRidge'] = new Array();
          currentType = 'mountain';
          document.getElementById("newMountainBTN").disabled = true;
          document.getElementById("newPlaneBTN").disabled = true;
          document.getElementById("newHorizontalReferenceStrokeBTN").disabled = false;
          document.getElementById("newHorizontalRidgeStrokeBTN").disabled = true;
          document.getElementById("newVerticalRidgeStrokeBTN").disabled = true;
          document.getElementById("saveBTN").disabled = true;
          document.getElementById("submitBTN").disabled = true;
        }

        function newPlane() {
          refreshCanvas();
          currentObject = new Object();
          currentObject['horizontalReference'] = new Array();
          currentObject['horizontalRidge'] = new Array();
          currentObject['verticalRidge'] = new Array();
          currentType = 'plane';
          document.getElementById("newMountainBTN").disabled = true;
          document.getElementById("newPlaneBTN").disabled = true;
          document.getElementById("newVerticalRidgeStrokeBTN").disabled = true;
          document.getElementById("newHorizontalReferenceStrokeBTN").disabled = false;
          document.getElementById("newHorizontalRidgeStrokeBTN").disabled = true;
          document.getElementById("saveBTN").disabled = true;
          document.getElementById("submitBTN").disabled = true;
        }

        function newHorizontalReferenceStroke() {
          var R = parseInt(currentStrokeStyle.slice(1, 3), 16);
          var G = parseInt(currentStrokeStyle.slice(3, 5), 16);
          var B = parseInt(currentStrokeStyle.slice(5, 7), 16);
          console.warn(R, G, B);
          if (R==0) {
            currentStrokeStyle = '#FF0000';
          } else {
            currentStrokeStyle = '#'+(R-30).toString(16)+'0000';
          }
          context.strokeStyle = currentStrokeStyle;
          console.warn(context.strokeStyle);
          context.beginPath();

          document.getElementById("newMountainBTN").disabled = true;
          document.getElementById("newPlaneBTN").disabled = true;
          document.getElementById("newHorizontalReferenceStrokeBTN").disabled = false;
          document.getElementById("newHorizontalRidgeStrokeBTN").disabled = false;
          if (currentType=="mountain"){
            document.getElementById("newVerticalRidgeStrokeBTN").disabled = false;
          } else if (currentType=="plane") {
            document.getElementById("newVerticalRidgeStrokeBTN").disabled = true;
          }
          document.getElementById("saveBTN").disabled = true;
          document.getElementById("submitBTN").disabled = true;
        }

        function newHorizontalRidgeStroke() {
          var R = parseInt(currentStrokeStyle.slice(1, 3), 16);
          var G = parseInt(currentStrokeStyle.slice(3, 5), 16);
          var B = parseInt(currentStrokeStyle.slice(5, 7), 16);
          console.warn(R, G, B);
          if (B==0) {
            currentStrokeStyle = '#0000FF';
          } else {
            currentStrokeStyle = '#0000'+(B-30).toString(16);
          }
          context.strokeStyle = currentStrokeStyle;
          console.warn(context.strokeStyle);
          context.beginPath();

          document.getElementById("newMountainBTN").disabled = true;
          document.getElementById("newPlaneBTN").disabled = true;
          document.getElementById("newHorizontalReferenceStrokeBTN").disabled = true;
          document.getElementById("newHorizontalRidgeStrokeBTN").disabled = false;
          if (currentType=="mountain"){
            document.getElementById("newVerticalRidgeStrokeBTN").disabled = false;
          } else if (currentType=="plane") {
            document.getElementById("newVerticalRidgeStrokeBTN").disabled = true;
          }
          document.getElementById("saveBTN").disabled = false;
          document.getElementById("submitBTN").disabled = true;
        }

        function newVerticalRidgeStroke() {
          var R = parseInt(currentStrokeStyle.slice(1, 3), 16);
          var G = parseInt(currentStrokeStyle.slice(3, 5), 16);
          var B = parseInt(currentStrokeStyle.slice(5, 7), 16);
          console.warn(R, G, B);
          if (G==0) {
            currentStrokeStyle = '#00FF00';
          } else {
            currentStrokeStyle = '#00'+(G-30).toString(16)+'00';
          }
          context.strokeStyle = currentStrokeStyle;
          console.warn(context.strokeStyle);
          context.beginPath();

          document.getElementById("newMountainBTN").disabled = true;
          document.getElementById("newPlaneBTN").disabled = true;
          document.getElementById("newHorizontalReferenceStrokeBTN").disabled = true;
          document.getElementById("newHorizontalRidgeStrokeBTN").disabled = false;
          document.getElementById("newVerticalRidgeStrokeBTN").disabled = false;
          document.getElementById("saveBTN").disabled = false;
          document.getElementById("submitBTN").disabled = true;
        }

        function save() {
          currentObject['horizontalReference'] = filterPixel(getPixel('#FF0000'));
          currentObject['horizontalRidge'] = filterPixel(getPixel('#0000FF'));
          currentObject['verticalRidge'] = filterPixel(getPixel('#00FF00'));
          currentObject['type'] = currentType;
          if (currentObject['horizontalReference'].length!=0 || 
              currentObject['horizontalRidge'].length!=0 || 
              currentObject['verticalRidge'].length!=0) {
            pixelList.push(currentObject);
            console.warn(pixelList);
            newMountain();
          }

          document.getElementById("newMountainBTN").disabled = false;
          document.getElementById("newPlaneBTN").disabled = false;
          document.getElementById("saveBTN").disabled = true;
          document.getElementById("newHorizontalReferenceStrokeBTN").disabled = true;
          document.getElementById("newHorizontalRidgeStrokeBTN").disabled = true;
          document.getElementById("newVerticalRidgeStrokeBTN").disabled = true;
          document.getElementById("submitBTN").disabled = false;
        }

        function refreshCanvas() {
          canvas = document.getElementById('canvas');
          var bgImg = document.getElementById('backgroundImage');
          if(canvas.getContext){        
            context = canvas.getContext('2d');   
          }
          canvas.width = bgImg.width;
          canvas.height = bgImg.height;
          context.lineWidth = 3;    
          context.strokeStyle = '#000000';
          context.fillStyle = 'rgba(0, 0, 0, 0)';  
        }

        function getPixel(color) {
          var pixels = context.getImageData(0, 0, canvas.width, canvas.height).data;
          var R = parseInt(color.slice(1, 3), 16);
          var G = parseInt(color.slice(3, 5), 16);
          var B = parseInt(color.slice(5, 7), 16);

          if (R!=0) {
            var tmp = new Object();
            for (var i=0; i<pixels.length; i+=4) {
              if (pixels[i+0]!=0 && pixels[i+1]==0 && pixels[i+2]==0) {
                if (tmp[pixels[i+0]]==undefined) {
                  tmp[pixels[i+0]] = new Array();
                }
                tmp[pixels[i+0]].push([(i/4)%canvas.width, (i/4)/canvas.width, pixels[i+0]]);
              }
            }
            return tmp;
          }

          if (G!=0) {
            var tmp = new Object();
            for (var i=0; i<pixels.length; i+=4) {
              if (pixels[i+1]!=0 && pixels[i+0]==0 && pixels[i+2]==0) {
                if (tmp[pixels[i+1]]==undefined) {
                  tmp[pixels[i+1]] = new Array();
                }
                tmp[pixels[i+1]].push([(i/4)%canvas.width, (i/4)/canvas.width, pixels[i+1]]);
              }
            }
            return tmp;
          }

          if (B!=0) {
            var tmp = new Object();
            for (var i=0; i<pixels.length; i+=4) {
              if (pixels[i+2]!=0 && pixels[i+0]==0 && pixels[i+1]==0) {
                if (tmp[pixels[i+2]]==undefined) {
                  tmp[pixels[i+2]] = new Array();
                }
                tmp[pixels[i+2]].push([(i/4)%canvas.width, (i/4)/canvas.width, pixels[i+2]]);
              }
            }
            return tmp;
          }

        }

        function filterPixel(pixelDict) {
          for (var key in pixelDict) {
            if (pixelDict[key].length<100) {
              delete pixelDict[key]; 
            }
          }
          return pixelDict;
        }

        refreshCanvas();
        canvas.onmousedown = function(e){      
          e.preventDefault();
          var x = e.clientX - canvas.offsetLeft;        
          var y = e.clientY - canvas.offsetTop;        
          context.moveTo(x,y);        
          canvas.onmousemove = function(e){            
            e.preventDefault();
            if (e.clientX>canvas.width||e.clientY>canvas.height||e.clientX<0||e.clientY<0) {
              canvas.onmousemove = null;
            } else {
              var x = e.clientX - canvas.offsetLeft;            
              var y = e.clientY - canvas.offsetTop;    
              context.lineTo(x,y);   
              context.stroke();
            }    
          };        
          canvas.onmouseup = function(e){            
            canvas.onmousemove = null;
          };    
        };
</script>
</html>